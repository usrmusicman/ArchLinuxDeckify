#!/usr/bin/env bash
# Gamemode Enhanced
# Explicit GPU / USB / PipeWire Low-Latency Wrapper
# Author: Alexander Mcmillan <linuxguy93@gmail.com>

# --------------------------
# COLORS & UTILS
# --------------------------
YLW='\033[1;33m'; GRN='\033[1;32m'; CYN='\033[1;36m'; RED='\033[1;31m'; NC='\033[0m'
notify()  { echo -e "${YLW}[GAMEMODE-ENHANCED]${NC} $1"; }
confirm() { echo -e "           â†³ ${GRN}APPLIED:${NC} $1"; }

# --------------------------
# USER & CONFIG
# --------------------------

# User running sudo command
REAL_USER=${SUDO_USER:-$USER}

# SteamOS session config file
STEAMOS_SESSION_CONFIG="/home/$REAL_USER/.config/steamos-session/steamos-session-config"

# Load session config
if [[ -f "$STEAMOS_SESSION_CONFIG" ]]; then
    source "$STEAMOS_SESSION_CONFIG"
else
    echo -e "${YLW}WARNING: Session config not found, using built-in defaults${NC}"
    echo -e "${YLW}Using default GPU_SETUP=$GPU_SETUP, RT_PRIO_USB=$RT_PRIO_USB, RT_PRIO_PIPEWIRE=$RT_PRIO_PIPEWIRE, RT_PRIO_BT=$RT_PRIO_BT, DEFAULT_QUANTUM=$DEFAULT_QUANTUM, DEFAULT_RATE=$DEFAULT_RATE${NC}"
fi

# --------------------------
# DEFAULTS (if not defined in config)
# --------------------------
GPU_SETUP=${GPU_SETUP:-nvidia}   # explicit, no auto-detect
RT_PRIO_USB=${RT_PRIO_USB:-97}
RT_PRIO_PIPEWIRE=${RT_PRIO_PIPEWIRE:-92}
RT_PRIO_BT=${RT_PRIO_BT:-87}

DEFAULT_QUANTUM=${DEFAULT_QUANTUM:-64}
DEFAULT_RATE=${DEFAULT_RATE:-48000}

# --------------------------
# CORE FUNCTIONS
# --------------------------

# Transparent Hugepages
manage_thp() {
    if [[ "$1" == "on" ]]; then
        echo never | tee /sys/kernel/mm/transparent_hugepage/enabled >/dev/null
        echo never | tee /sys/kernel/mm/transparent_hugepage/defrag >/dev/null
        confirm "Transparent Hugepages -> never"
    else
        echo always | tee /sys/kernel/mm/transparent_hugepage/enabled >/dev/null
        echo always | tee /sys/kernel/mm/transparent_hugepage/defrag >/dev/null
        confirm "Transparent Hugepages -> default"
    fi
}

# CPU governor & swappiness
manage_cpu() {
    if [[ "$1" == "on" ]]; then
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
            echo "performance" | tee "$cpu" >/dev/null 2>&1
        done
        for epp in /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference; do
            [[ -f "$epp" ]] && echo "performance" | tee "$epp" >/dev/null
        done
        echo "10" | tee /proc/sys/vm/swappiness >/dev/null
        confirm "CPU Governor -> performance"
    else
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
            echo "schedutil" | tee "$cpu" >/dev/null 2>&1 || echo "powersave" | tee "$cpu" >/dev/null 2>&1
        done
        echo "60" | tee /proc/sys/vm/swappiness >/dev/null
        confirm "CPU Governor -> default"
    fi
}

# WiFi power save
manage_wifi() {
    local p_state=$([[ "$1" == "on" ]] && echo "off" || echo "on")
    for dev in $(iw dev | awk '$1=="Interface"{print $2}'); do
        iw dev "$dev" set power_save "$p_state" 2>/dev/null
    done
    confirm "WiFi Power Save -> $p_state"
}

# USB threads
manage_usb() {
    local pids=$(pgrep -f "xhci")
    if [[ "$1" == "on" ]]; then
        echo -1 | tee /sys/module/usbcore/parameters/autosuspend >/dev/null
        for pid in $pids; do chrt -f -p $RT_PRIO_USB "$pid"; done
        for pid in $pids; do
            prio=$(chrt -p "$pid" 2>/dev/null | awk -F': ' '/priority/ {print $2}' | xargs)
            confirm "USB PID $pid -> RT priority $prio"
        done
        confirm "USB Threads -> autosuspend -1 applied"
    else
        echo 2 | tee /sys/module/usbcore/parameters/autosuspend >/dev/null
        for pid in $pids; do chrt -o -p 0 "$pid"; done
        for pid in $pids; do
            prio=$(chrt -p "$pid" 2>/dev/null | awk -F': ' '/priority/ {print $2}' | xargs)
            confirm "USB PID $pid -> RT priority $prio (default)"
        done
    fi
}

# PipeWire threads
manage_pipewire() {
    local pids=$(pgrep -x "pipewire")
    if [[ "$1" == "on" ]]; then
        for pid in $pids; do chrt -f -p $RT_PRIO_PIPEWIRE "$pid"; done
        for pid in $pids; do
            prio=$(chrt -p "$pid" 2>/dev/null | awk -F': ' '/priority/ {print $2}' | xargs)
            confirm "PipeWire PID $pid -> RT priority $prio"
        done
    else
        for pid in $pids; do chrt -o -p 0 "$pid"; done
        for pid in $pids; do
            prio=$(chrt -p "$pid" 2>/dev/null | awk -F': ' '/priority/ {print $2}' | xargs)
            confirm "PipeWire PID $pid -> RT priority $prio (default)"
        done
    fi
}

# GPU performance
manage_gpu() {
    local action=$1
    case "$GPU_SETUP" in
        nvidia|nvidia_hybrid)
            local gpu_index=0
            [[ "$GPU_SETUP" == "nvidia_hybrid" ]] && gpu_index=1
            if [[ "$action" == "on" ]]; then
                nvidia-smi -pm 1 >/dev/null 2>&1
                runuser -u "$REAL_USER" -- nvidia-settings -a "[gpu:$gpu_index]/GPUPowerMizerMode=1" >/dev/null 2>&1
                confirm "GPU NVIDIA gpu:$gpu_index (Maximum Performance)"
            else
                runuser -u "$REAL_USER" -- nvidia-settings -a "[gpu:$gpu_index]/GPUPowerMizerMode=0" >/dev/null 2>&1
                nvidia-smi -pm 0 >/dev/null 2>&1
                confirm "GPU NVIDIA gpu:$gpu_index (Default)"
            fi
            ;;
        nvidia_nvk)
            if [[ "$action" == "on" ]]; then
                echo high | tee /sys/class/drm/card1/device/power_dpm_force_performance_level >/dev/null 2>&1
                confirm "GPU (Nouveau) -> High Performance"
            else
                echo auto | tee /sys/class/drm/card1/device/power_dpm_force_performance_level >/dev/null 2>&1
                confirm "GPU (Nouveau) -> Default"
            fi
            ;;
        amd)
            if [[ "$action" == "on" ]]; then
                for dev in /sys/class/drm/card*/device/; do
                    [[ -f "${dev}power_dpm_force_performance_level" ]] && echo "high" | tee "${dev}power_dpm_force_performance_level" >/dev/null 2>&1
                    [[ -f "${dev}pp_power_profile_mode" ]] && echo "1" | tee "${dev}pp_power_profile_mode" >/dev/null 2>&1
                done
                confirm "GPU (AMD) -> High Performance"
            else
                for dev in /sys/class/drm/card*/device/; do
                    [[ -f "${dev}power_dpm_force_performance_level" ]] && echo "auto" | tee "${dev}power_dpm_force_performance_level" >/dev/null 2>&1
                    [[ -f "${dev}pp_power_profile_mode" ]] && echo "0" | tee "${dev}pp_power_profile_mode" >/dev/null 2>&1
                done
                confirm "GPU (AMD) -> Default"
            fi
            ;;
        intel)
            for dev in /sys/class/drm/card*/device/gt/gt*/freq0/; do
                if [[ -d "$dev" ]]; then
                    if [[ "$action" == "on" ]]; then
                        max_f=$(cat "${dev}rp0_freq_mhz" 2>/dev/null || cat "${dev}max_freq_mhz" 2>/dev/null)
                        [[ -n "$max_f" ]] && echo "$max_f" | tee "${dev}min_freq_mhz" >/dev/null 2>&1
                        confirm "GPU (Intel) -> Locked Max (${max_f}MHz)"
                    else
                        min_f=$(cat "${dev}rpn_freq_mhz" 2>/dev/null || echo "300")
                        echo "$min_f" | tee "${dev}min_freq_mhz" >/dev/null 2>&1
                        confirm "GPU (Intel) -> Dynamic (Default)"
                    fi
                fi
            done
            ;;
        *)
            echo -e "${RED}Unknown GPU_SETUP value: $GPU_SETUP${NC}"
            ;;
    esac
}

# Bluetooth
manage_bluetooth() {
    local hci="/sys/kernel/debug/bluetooth/hci0"
    local pids=$(pgrep -x "bluetoothd")
    if [[ "$1" == "on" ]]; then
        if [[ -d "$hci" ]]; then
            echo 12 | tee "$hci/conn_max_interval" >/dev/null 2>&1
            echo 6  | tee "$hci/conn_min_interval" >/dev/null 2>&1
        fi
        for pid in $pids; do chrt -f -p $RT_PRIO_BT "$pid"; done
        for pid in $pids; do
            prio=$(chrt -p "$pid" 2>/dev/null | awk -F': ' '/priority/ {print $2}' | xargs)
            confirm "Bluetooth PID $pid -> RT priority $prio"
        done
    else
        for pid in $pids; do chrt -o -p 0 "$pid"; done
        for pid in $pids; do
            prio=$(chrt -p "$pid" 2>/dev/null | awk -F': ' '/priority/ {print $2}' | xargs)
            confirm "Bluetooth PID $pid -> RT priority $prio (default)"
        done
    fi
}

# PipeWire quantum & rate
set_pipewire_audio() {
    local quantum=${1:-$DEFAULT_QUANTUM}
    local rate=${2:-$DEFAULT_RATE}

    runuser -u "$REAL_USER" -- pw-metadata -n settings 0 clock.force-quantum "$quantum" >/dev/null 2>&1
    confirm "PipeWire Quantum -> $quantum"

    runuser -u "$REAL_USER" -- pw-metadata -n settings 0 clock.force-rate "$rate" >/dev/null 2>&1
    confirm "PipeWire Sample Rate -> $rate Hz"
}

# SCX Scheduler
start_scheduler() {
    local sched=${SCHED_NAME:-lavd}
    local mode=${SCHED_MODE:-lowlatency}

    if command -v scxctl &>/dev/null; then
        scxctl stop >/dev/null 2>&1
        sleep 0.2
        scxctl start --sched "$sched" --mode "$mode" &
        confirm "Scheduler started -> $sched (Mode: $mode)"
    else
        echo -e "${RED}SCX Scheduler not found!${NC}"
    fi
}

# Restore defaults
revert_defaults() {
    notify "Restoring system defaults..."
    manage_cpu off
    manage_wifi off
    manage_usb off
    manage_pipewire off
    manage_gpu off
    manage_bluetooth off
    manage_thp off

    if command -v scxctl &>/dev/null; then
        scxctl stop >/dev/null 2>&1
        confirm "Scheduler stopped"
    fi
    notify "System defaults restored"
}

# --------------------------
# HELP FUNCTION
# --------------------------
show_help() {
    echo -e "${YLW}Linux Gamemode Enhanced${NC}"
    echo -e "-----------------------------------------------"

    echo -e "${GRN}USAGE:${NC} sudo $0 [OPTIONS]"
    echo -e "${CYN}OPTIONS:${NC}"
    echo -e "  ${YLW}-q <quantum>${NC}      PipeWire buffer quantum (default: ${DEFAULT_QUANTUM})"
    echo -e "  ${YLW}-r <rate>${NC}         PipeWire sample rate (default: ${DEFAULT_RATE} Hz)"
    echo -e "  ${YLW}-s <scheduler>${NC}    Start SCX scheduler (default: lavd)"
    echo -e "  ${YLW}-m <mode>${NC}         Mode profile for SCX scheduler (default: lowlatency)"
    echo -e "  ${YLW}-x${NC}                Restore system defaults"
    echo -e "  ${YLW}-h${NC}                Show this help message"

    echo -e "\n${YLW}--- SCX Schedulers ---${NC}"
    echo -e "  * ${GRN}beerland${NC}   - High-throughput, heavy compilation/IO"
    echo -e "  * ${GRN}bpfland${NC}    - Direct BPF, minimal scheduling overhead"
    echo -e "  * ${GRN}cosmos${NC}     - High-performance general-purpose"
    echo -e "  * ${GRN}flash${NC}      - Ultra-aggressive preemption"
    echo -e "  * ${GRN}lavd${NC}       - Latency-critical Auto-Vblank (Best for Audio)"
    echo -e "  * ${GRN}p2dq${NC}       - Power-aware Dual Queue (Balanced laptops)"
    echo -e "  * ${GRN}tickless${NC}   - Reduced timer interrupts for CPU consistency"
    echo -e "  * ${GRN}rustland${NC}   - High-safety BPF written in Rust"
    echo -e "  * ${GRN}rusty${NC}      - Efficient modern scheduler for multicore desktops"

    echo -e "\n${YLW}--- Supported Mode Profiles ---${NC}"
    echo -e "  * ${CYN}gaming${NC}      - Interactive latency & vblank sync"
    echo -e "  * ${CYN}lowlatency${NC} - Maximum preemption, RT applications"
    echo -e "  * ${CYN}powersave${NC}   - Efficient, battery-friendly mode"
    echo -e "  * ${CYN}balanced${NC}    - Standard desktop responsiveness"

    echo -e "\n${YLW}--- GPU Setup Options (Editable in config) ---${NC}"
    echo -e "  * ${CYN}nvidia${NC}         - Dedicated NVIDIA GPU"
    echo -e "  * ${CYN}nvidia_hybrid${NC}  - NVIDIA + Integrated GPU (Hybrid)"
    echo -e "  * ${CYN}nvidia_nvk${NC}     - NVIDIA with FOSS driver (Nouveau)"
    echo -e "  * ${CYN}amd${NC}            - Dedicated AMD GPU"
    echo -e "  * ${CYN}intel${NC}          - Integrated Intel GPU"

    echo -e "\n${YLW}--- RT Priority Defaults (Editable in config) ---${NC}"
    echo -e "  USB       : ${CYN}$RT_PRIO_USB${NC}"
    echo -e "  PipeWire  : ${CYN}$RT_PRIO_PIPEWIRE${NC}"
    echo -e "  Bluetooth : ${CYN}$RT_PRIO_BT${NC}"

    echo -e "-----------------------------------------------"
    exit 0
}

# --------------------------
# MAIN OPTIONS PARSING
# --------------------------
[[ $EUID -ne 0 ]] && { echo -e "${RED}ERROR: Run with sudo${NC}"; exit 1; }

while getopts "q:r:s:m:xh" opt; do
    case "$opt" in
        q) QUANTUM=$OPTARG ;;
        r) RATE=$OPTARG ;;
        s) SCHED_NAME=$OPTARG ;;
        m) SCHED_MODE=$OPTARG ;;
        x) revert_defaults; exit 0 ;;
        h) show_help ;;
        *) show_help ;;
    esac
done

# --------------------------
# ACTIVATE PERFORMANCE MODE
# --------------------------
notify "Engaging Linux Audio Performance Mode..."
manage_thp on
manage_cpu on
manage_wifi on
manage_usb on
manage_pipewire on
manage_gpu on
manage_bluetooth on
set_pipewire_audio "$QUANTUM" "$RATE"
start_scheduler
notify "Linux Audio Performance Mode -> ACTIVE"
