#!/usr/bin/env bash
# steamos-gamemode-enhanced v3.0 (scx_lavd Integration)
# Logic: Snapshot system -> Boost GPU/USB -> Engage SCX Scheduler -> Restore on Stop

# ------------------------------------------------
# CONFIGURATION
# ------------------------------------------------
CPU_STATE_FILE="/tmp/steamos-gamemode-cpu.state"
IRQ_STATE_FILE="/tmp/steamos-gamemode-irq.state"

# 360Hz "Nuclear" Priorities
RT_PRIORITY=95
USB_PRIORITY=94

# Input Arguments
ACTION=$1      # start or stop
GPU_VENDOR=$2  # nvidia, nouveau, amd, intel

# ------------------------------------------------
# HELPER FUNCTIONS
# ------------------------------------------------
log() {
    echo -e "\033[1;33m[GAMEMODE]\033[0m $1"
}

get_gpu_irq_names() {
    case "$GPU_VENDOR" in
        nvidia)  echo "nvidia" ;;
        nouveau) echo "nouveau" ;; # For NVK/FOSS drivers
        amd)     echo "amdgpu" ;;
        intel)   echo "i915|xe" ;;
        *)       echo "none" ;;
    esac
}

# ------------------------------------------------
# SCHED-EXT (SCX) MANAGER
# ------------------------------------------------
manage_scx_start() {
    # Check if the scxctl daemon is already running
    if pgrep -x "scxctl" > /dev/null; then
        log "scxctl is already active. Switching to 'lavd' (gaming mode)..."
        sudo /usr/bin/scxctl switch --sched lavd --mode gaming > /dev/null 2>&1 &
    else
        log "Starting scxctl with 'lavd' (gaming mode)..."
        # Start in background, but ensure it doesn't block
        sudo /usr/bin/scxctl start --sched lavd --mode gaming > /dev/null 2>&1 &

        # Wait briefly to ensure it initializes
        sleep 2
        if pgrep -x "scxctl" > /dev/null; then
            log "scx_lavd started successfully."
        else
            log "WARNING: scxctl failed to start."
        fi
    fi
}

manage_scx_stop() {
    if pgrep -x "scxctl" > /dev/null; then
        log "Stopping scxctl scheduler..."
        sudo /usr/bin/scxctl stop
    else
        log "scxctl was not running."
    fi
}

# ------------------------------------------------
# ENABLE PERFORMANCE (START)
# ------------------------------------------------
enable_performance() {
    log "Engaging High-Performance Mode (GPU: $RT_PRIORITY, USB: $USB_PRIORITY)..."

    # 1. Engage Sched-ext (LAVD)
    manage_scx_start

    # 2. CPU Governor -> Performance
    # Snapshot only if file doesn't exist (preserve original state)
    if [[ ! -f "$CPU_STATE_FILE" ]]; then
        cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor > "$CPU_STATE_FILE" 2>/dev/null
    fi
    echo "performance" | sudo tee /sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_governor > /dev/null
    log "CPU Governor locked to PERFORMANCE."

    # 3. GPU IRQ Boosting
    rm -f "$IRQ_STATE_FILE"
    touch "$IRQ_STATE_FILE"

    GPU_REGEX=$(get_gpu_irq_names)
    if [[ "$GPU_REGEX" != "none" ]]; then
        log "Scanning for $GPU_REGEX interrupts..."
        # Extract IRQ numbers
        IRQS=$(grep -E "$GPU_REGEX" /proc/interrupts | awk -F: '{print $1}' | tr -d ' ')

        for irq in $IRQS; do
            # Find threads for this IRQ
            PIDS=$(pgrep -f "irq/$irq-")
            for pid in $PIDS; do
                if [[ -n "$pid" ]]; then
                    # Snapshot current priority
                    CURRENT_INFO=$(chrt -p "$pid")
                    POLICY=$(echo "$CURRENT_INFO" | grep "policy" | awk '{print $6}')
                    PRIO=$(echo "$CURRENT_INFO" | grep "priority" | awk '{print $6}')

                    case "$POLICY" in
                        "SCHED_FIFO")  FLAG="-f" ;;
                        "SCHED_RR")    FLAG="-r" ;;
                        "SCHED_IDLE")  FLAG="-i" ;;
                        "SCHED_BATCH") FLAG="-b" ;;
                        *)             FLAG="-o" ;;
                    esac

                    echo "$pid $FLAG $PRIO" >> "$IRQ_STATE_FILE"

                    # Boost to FIFO 95
                    sudo chrt -f -p "$RT_PRIORITY" "$pid"
                    log " -> Boosted GPU PID $pid (IRQ $irq) to FIFO $RT_PRIORITY"
                fi
            done
        done
    else
        log "No matching GPU interrupts found for vendor: $GPU_VENDOR"
    fi

    # 4. USB IRQ Boosting (xhci_hcd)
    log "Scanning for USB (xhci_hcd) interrupts..."
    USB_PIDS=$(pgrep -f "irq/.*xhci_hcd")
    for upid in $USB_PIDS; do
        if [[ -n "$upid" ]]; then
            U_INFO=$(chrt -p "$upid")
            U_POLICY=$(echo "$U_INFO" | grep "policy" | awk '{print $6}')
            U_PRIO=$(echo "$U_INFO" | grep "priority" | awk '{print $6}')

            case "$U_POLICY" in
                "SCHED_FIFO")  U_FLAG="-f" ;;
                "SCHED_RR")    U_FLAG="-r" ;;
                *)             U_FLAG="-o" ;;
            esac

            echo "$upid $U_FLAG $U_PRIO" >> "$IRQ_STATE_FILE"
            sudo chrt -f -p "$USB_PRIORITY" "$upid"
            log " -> Boosted USB PID $upid to FIFO $USB_PRIORITY"
        fi
    done
}

# ------------------------------------------------
# DISABLE PERFORMANCE (STOP)
# ------------------------------------------------
disable_performance() {
    log "Restoring Original System State..."

    # 1. Stop Sched-ext (Restore standard scheduler)
    manage_scx_stop

    # 2. Restore CPU Governor
    if [[ -f "$CPU_STATE_FILE" ]]; then
        OLD_GOV=$(cat "$CPU_STATE_FILE")
        if [[ -n "$OLD_GOV" ]]; then
            echo "$OLD_GOV" | sudo tee /sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_governor > /dev/null
            log "CPU Governor restored to: $OLD_GOV"
        fi
        rm "$CPU_STATE_FILE"
    else
        # Fallback safety
        echo "schedutil" | sudo tee /sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_governor > /dev/null 2>&1
    fi

    # 3. Restore IRQ Priorities
    if [[ -f "$IRQ_STATE_FILE" ]]; then
        log "Restoring IRQ priorities..."
        while read -r line; do
            [[ -z "$line" ]] && continue
            read -r pid flag prio <<< "$line"

            if [[ -n "$pid" && -e "/proc/$pid" ]]; then
                sudo chrt "$flag" -p "$prio" "$pid"
            fi
        done < "$IRQ_STATE_FILE"
        rm "$IRQ_STATE_FILE"
        log "All IRQ threads restored."
    fi
}

# ------------------------------------------------
# MAIN EXECUTION
# ------------------------------------------------
case "$ACTION" in
    start)
        enable_performance
        ;;
    stop)
        disable_performance
        ;;
    *)
        echo "Usage: $0 {start|stop} {nvidia|nouveau|amd|intel}"
        exit 1
        ;;
esac
