#!/usr/bin/env bash

# ------------------------------------------------
# Find Configuration File
# ------------------------------------------------

if [ -z "$SYSTEM_GPU" ]; then

  # Source configuration file
  source "$STEAMOS_SESSION_CONFIG"

fi

# ------------------------------------------------
# Intel High-Performance Gaming Environment
# ------------------------------------------------

# [nothrottle]: Disables driver-side frequency throttling to keep clocks pinned
# [rebind]: Helps with memory management on Arc/Xe architectures
export INTEL_DEBUG=nothrottle,rebind

# Enables multi-threaded OpenGL/Vulkan command submission
export mesa_glthread=true

# [ANV_ENABLE_FBC]: Enables Frame Buffer Compression to save bandwidth
export ANV_ENABLE_FBC=1

# [INTEL_MEASURE]: Optimization for internal pipeline tracking (Set to 0 for pure speed)
export INTEL_MEASURE=0

# Standard 64-bit Intel Vulkan ICD path
export VK_ICD_FILENAMES="/usr/share/vulkan/icd.d/intel_icd.x86_64.json"

# ------------------------------------------------
# Steamdeck Gamescope UI Session
# ------------------------------------------------

# 1. Silencing systemctl and pkill (Added -q and &>/dev/null)
pkill -9 kwin_wayland 2>/dev/null
clear

# 2. Run Gamescope with Upscaling Logic
# -w/-h = Internal Render (What the game thinks it is)
# -W/-H = Physical Output (The Monitor's resolution)
gamescope \
  -w "$RENDER_WIDTH" \
  -h "$RENDER_HEIGHT" \
  -W "$SCREENWIDTH" \
  -H "$SCREENHEIGHT" \
  -r "$REFRESHRATE" \
  -f \
  --adaptive-sync \
  --immediate-flips \
  --force-grab-cursor \
  -S fit \
  -F "$UPSCALE_FILTER" \
  --sharpness "$SHARPNESS" \
  --hdr-enabled \
  --mangoapp \
  --steam \
  --xwayland-count 2 \
  -- \
  steam -steamdeck -steamos3 -gamepadui >/dev/null 2>$HOME/.steamos-session-gamescope.log
