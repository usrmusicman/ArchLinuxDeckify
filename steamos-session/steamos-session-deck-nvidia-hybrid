#!/usr/bin/env bash

# ------------------------------------------------
# Find Configuration File
# ------------------------------------------------

if [ -z "$SYSTEM_GPU" ]; then

  # Source configuration file
  source "$STEAMOS_SESSION_CONFIG"

fi

# ------------------------------------------------
# NVIDIA + iGPU Hybrid High-Performance Environment
# ------------------------------------------------

# NVIDIA Core Settings
export __GL_MaxFramesAllowed=1
export __GL_SHADER_DISK_CACHE=1
export __GL_SHADER_DISK_CACHE_PATH="$HOME/.cache/nvidia"

# Prime Render Offload Logic (The "Handoff")
export __GLX_VENDOR_LIBRARY_NAME=nvidia
export __NV_PRIME_RENDER_OFFLOAD=1
export __VK_LAYER_NV_optimus=NVIDIA_only

# Wayland/Gamescope Specifics for Hybrid
export GBM_BACKEND=nvidia-drm
export PROTON_ENABLE_NVAPI=1
export PROTON_HIDE_NVIDIA_GPU=0

# Disable atomic check to prevent "flip" failures on some laptop panels
export WLR_DRM_NO_ATOMIC=1

# [2026 LATENCY FIX]: Force the iGPU to wait for the dGPU frame completion.
# This eliminates the "half-frame" tearing common in Optimus setups.
export __NV_PRIME_RENDER_OFFLOAD_TRUSTED=1
export VK_ICD_FILENAMES="/usr/share/vulkan/icd.d/nvidia_icd.json"

# ------------------------------------------------
# Steamdeck Gamescope UI Session
# ------------------------------------------------

# 3. Run Gamescope with Upscaling Logic
# -w/-h = Internal Render (What the game thinks it is)
# -W/-H = Physical Output (The Monitor's resolution)
gamescope \
  -w "$RENDER_WIDTH" \
  -h "$RENDER_HEIGHT" \
  -W "$SCREENWIDTH" \
  -H "$SCREENHEIGHT" \
  -r "$REFRESHRATE" \
  -f \
  --adaptive-sync \
  --immediate-flips \
  --force-grab-cursor \
  -S fit \
  -F "$UPSCALE_FILTER" \
  --sharpness "$SHARPNESS" \
  --hdr-enabled \
  --mangoapp \
  --steam \
  --xwayland-count 2 \
  -- \
  steam -steamdeck -steamos3 -gamepadui >/dev/null 2>$HOME/.steamos-session-gamescope.log
