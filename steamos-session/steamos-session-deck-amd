#!/usr/bin/env bash

# ------------------------------------------------
# Find Configuration File
# ------------------------------------------------

if [ -z "$SYSTEM_GPU" ]; then

  # Source configuration file
  source "$STEAMOS_SESSION_CONFIG"

fi

# ------------------------------------------------
# AMD High-Performance Gaming Environment
# ------------------------------------------------

# Ensure we use the community-standard RADV driver (Superior to AMDVLK for gaming)
export AMD_VULKAN_ICD=RADV

# [GPL]: Eliminates shader compilation stutter (The #1 fix for Linux gaming)
# [NGGC]: Next-Gen Geometry Culling - Speeds up rendering on RDNA 2/3/4 cards
# [SAM]: Forces Smart Access Memory for faster CPU-to-GPU communication
export RADV_PERFTEST=gpl,nggc,sam

# VRS=1 forces 1x1 shading (Full Quality). Use 2 or 2x2 if you need more FPS for 360Hz.
export RADV_FORCE_VRS=1

# Forces 16x Anisotropic Filtering at the driver level for crisper textures
export RADV_TEX_ANISO=16

# [nocompute]: Simplifies the GPU queue to prevent micro-stutters/pacing issues
export RADV_DEBUG=nocompute

# Enables the persistent disk cache for shaders (Speeds up game launch times)
export RADV_SHADER_CACHE=1

# [NEW 2026]: Pure 64-bit environment.
# NOTE: If an EAC game (e.g., Halo, Apex) fails with "Unexpected Error",
# comment these two lines out first.
export PROTON_USE_WOW64=1

# Points specifically to the 64-bit Mesa Radeon Vulkan driver path
export VK_ICD_FILENAMES="/usr/share/vulkan/icd.d/radeon_icd.x86_64.json"

# ------------------------------------------------
# Steamdeck Gamescope UI Session
# ------------------------------------------------

# 2. Run Gamescope with Upscaling Logic
# -w/-h = Internal Render (What the game thinks it is)
# -W/-H = Physical Output (The Monitor's resolution)
gamescope \
  -w "$RENDER_WIDTH" \
  -h "$RENDER_HEIGHT" \
  -W "$SCREENWIDTH" \
  -H "$SCREENHEIGHT" \
  -r "$REFRESHRATE" \
  -f \
  --adaptive-sync \
  --immediate-flips \
  --force-grab-cursor \
  -S fit \
  -F "$UPSCALE_FILTER" \
  --sharpness "$SHARPNESS" \
  --hdr-enabled \
  --mangoapp \
  --steam \
  --xwayland-count 2 \
  -- \
  steam -steamdeck -steamos3 -gamepadui >/dev/null 2>$HOME/.steamos-session-gamescope.log
