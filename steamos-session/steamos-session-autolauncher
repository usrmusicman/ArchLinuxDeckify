#!/usr/bin/env bash
# steamos-session-autolauncher (v3.3 - Robust Supervisor)

# ------------------------------------------------
# SETUP
# ------------------------------------------------
# Redirect all output to a log file for debugging (viewable in TTY)
LOG_FILE="/tmp/steamos-autolaunch.log"
exec > >(tee -a "$LOG_FILE") 2>&1
echo "--- New Session Launch: $(date) ---"

# Load Configuration
if [[ -f "$STEAMOS_SESSION_CONFIG" ]]; then
    source "$STEAMOS_SESSION_CONFIG"
else
    echo "ERROR: Config file not found at $STEAMOS_SESSION_CONFIG"
    exit 1
fi

# ------------------------------------------------
# LAUNCH SESSION (BLOCKING)
# ------------------------------------------------

if [[ "$GPU_SETUP" == "amd" ]]; then
    echo "Launching AMD Session..."
    bash "$STEAMOS_SESSION_AMD"

elif [[ "$GPU_SETUP" == "intel" ]]; then
    echo "Launching Intel Session..."
    bash "$STEAMOS_SESSION_INTEL"

elif [[ "$GPU_SETUP" == "nvidia" ]]; then
    echo "Launching Dedicated Nvidia Session..."
    bash "$STEAMOS_SESSION_NVIDIA"

elif [[ "$GPU_SETUP" == "nvidia_hybrid" ]]; then
    echo "Launching Hybrid Nvidia Session..."
    bash "$STEAMOS_SESSION_NVIDIA_HYBRID"

elif [[ "$GPU_SETUP" == "nvidia_nvk" ]]; then
    echo "Launching NVK (FOSS) Session..."
    bash "$STEAMOS_SESSION_NVIDIA_NVK"

else
    echo "Launching Fallback Mesa Session..."
    bash "$STEAMOS_SESSION_MESA"

fi

# When the session script finishes (user quits Steam)
