#!/usr/bin/env bash

# ------------------------------------------------
# Find Configuration File
# ------------------------------------------------

if [ -z "$SYSTEM_GPU" ]; then

  # Source configuration file
  source "$STEAMOS_SESSION_CONFIG"

fi

# ------------------------------------------------
# Generic/Unknown GPU High-Performance Gaming Environment
# ------------------------------------------------

# mesa_glthread is safe for almost 99% of Mesa-supported drivers and helps CPU overhead.
export mesa_glthread=true

# Use the experimental Windows Wine on WOW64 translation to 32bit Windows calls environment. Comment out the get Anti-Cheat titles working.
export PROTON_USE_WOW64=1

# ------------------------------------------------
# Steamdeck Gamescope UI Session
# ------------------------------------------------

# 2. Run Gamescope with Upscaling Logic
# -w/-h = Internal Render (What the game thinks it is)
# -W/-H = Physical Output (The Monitor's resolution)
gamescope \
  -w "$RENDER_WIDTH" \
  -h "$RENDER_HEIGHT" \
  -W "$SCREENWIDTH" \
  -H "$SCREENHEIGHT" \
  -r "$REFRESHRATE" \
  -f \
  --adaptive-sync \
  --immediate-flips \
  --force-grab-cursor \
  -S fit \
  -F "$UPSCALE_FILTER" \
  --sharpness "$SHARPNESS" \
  --hdr-enabled \
  --mangoapp \
  --steam \
  --xwayland-count 2 \
  -- \
  steam -steamdeck -steamos3 -gamepadui >/dev/null 2>$HOME/.steamos-session-gamescope.log
