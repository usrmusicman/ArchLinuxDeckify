#!/usr/bin/env bash

#### Your username running the script
USERNAME="artofmusic"

### Resolution and framerate choices
SCREENWIDTH=2560
SCREENHEIGHT=1440
REFRESHRATE=360

# Directory where the binaries are stored
BINARY_BASE_DIR="/home/${USERNAME}/.local/bin/steamos-session"

#### Run commands, DO NOT TOUCH ###
if [[ "$EUID" -eq 0 ]]; then

    # Grab current TTY
    ORIGINAL_SESSION_TTY=$(fgconsole)

    # SteamOS gaming session TTY
    STEAMOS_SESSION_TTY=3

    # Persist globally for non-root shells if needed
    cat > /tmp/steamdeck-env.sh <<EOF
export ORIGINAL_SESSION_TTY=$ORIGINAL_SESSION_TTY
export STEAMOS_SESSION_TTY=$STEAMOS_SESSION_TTY
export BINARY_BASE_DIR=$BINARY_BASE_DIR
export SCREENWIDTH=$SCREENWIDTH
export SCREENHEIGHT=$SCREENHEIGHT
export REFRESHRATE=$REFRESHRATE
EOF
    chmod 644 /tmp/steamdeck-env.sh

    # Attempt graceful shutdown of TTY3 first
    pkill -t tty${STEAMOS_SESSION_TTY}

    # If processes remain, kill hard
    pkill -9 -t tty${STEAMOS_SESSION_TTY}

    # Switch to SteamOS session TTY
    chvt $STEAMOS_SESSION_TTY

fi
