#!/usr/bin/env bash
# steamos-gamemode-enhanced v21.5

# ------------------------------------------------
# 1. CONFIGURATION & PRIORITIES
# ------------------------------------------------
RT_PRIO_NVIDIA=97
RT_PRIO_USB=95
RT_PRIO_BT=93
RT_PRIO_PIPEWIRE=91
RT_PRIO_RAKARRACK=93
SWAPPINESS_TARGET=10

RESTORE_RT_PRIO_IRQ=50
RESTORE_RT_PRIO_PROC=0

notify() { echo -e "\033[1;33m[GAMEMODE]\033[0m $1"; }

# ------------------------------------------------
# 2. HELP MENU
# ------------------------------------------------
show_help() {
    echo -e "\033[1;32mSTEAMOS/ARCH GAMEMODE ENHANCED v21.5\033[0m"
    echo -e "----------------------------------------------------------------"
    echo -e "USAGE:"
    echo -e "  sudo $0 -o [on|off] -v [vendor]      Manage performance state"
    echo -e "  sudo $0 -s                           Display current status report"
    echo -e ""
    echo -e "OPTIONS:"
    echo -e "  -o on         Engage high-performance and pro-audio tweaks"
    echo -e "  -o off        Restore system to standard/power-saving state"
    echo -e "  -v nvidia     Apply Nvidia-specific GPU and IRQ optimizations"
    echo -e "  -v amd        Apply AMD Radeon DPM performance levels"
    echo -e "  -v intel      Force Intel integrated GPU to max frequency"
    echo -e ""
    echo -e "MODULES INCLUDED:"
    echo -e "  - CPU Gov     Forces 'performance' mode & EPP tweaks"
    echo -e "  - SCX Sched   Directly starts LAVD (gaming-optimized scheduler)"
    echo -e "  - IRQ RT      Elevates Nvidia & USB interrupts (97/95)"
    echo -e "  - Audio RT    Pins Rakarrack & PipeWire to Real-Time (93/91)"
    echo -e "  - Latency     Disables Wi-Fi Power Save & tightens Bluetooth polling"
    echo -e "----------------------------------------------------------------"
    exit 0
}

# ------------------------------------------------
# 3. STATUS REPORT
# ------------------------------------------------
check_status() {
    echo "================================================================"
    echo "    STEAMOS/ARCH GAMEMODE ENHANCED STATUS REPORT"
    echo "================================================================"
    local gov=$(cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2>/dev/null | head -n 1)
    echo -e "CPU Gov:      ${gov:-N/A}"

    local scx_proc=$(pgrep -af scx_lavd | head -n 1)
    if [[ -n "$scx_proc" ]]; then
        echo -e "SCX Sched:    \033[1;32mACTIVE\033[0m (LAVD)"
    else
        echo -e "SCX Sched:    \033[1;31mINACTIVE\033[0m"
    fi

    local wifi_ps=$(iw dev | grep "power save" | awk '{print $3}' | head -n 1)
    echo -e "Wi-Fi Power:  ${wifi_ps^^:-UNKNOWN}"

    echo "Process Priorities (RT):"
    ps -eo rtprio,comm | awk -v pw=$RT_PRIO_PIPEWIRE -v rk=$RT_PRIO_RAKARRACK -v bt=$RT_PRIO_BT \
    '$2 ~ /bluetoothd|pipewire|rakarrack|steam|gamescope/ {
        prio_val = ($1 ~ /-/ || $1 == "") ? "0" : $1;
        status = (prio_val != "0" && prio_val >= 90) ? "OPTIMIZED" : "Std";
        printf "            - %-15s (Prio: %s) [%s]\n", $2, prio_val, status
    }' | sort -u

    echo "Hardware IRQs (RT):"
    ps -eo rtprio,psr,comm | grep -E "irq/[0-9]+-(nvidia|xhci)" | awk \
    '{
        status = ($1 >= 90) ? "OPTIMIZED" : "RESTORED/Std";
        printf "            - %-15s (Prio: %s | Core: %s) [%s]\n", $3, $1, $2, status
    }' | sort -u
    echo "================================================================"
}

# ------------------------------------------------
# 4. CORE SUB-ROUTINES
# ------------------------------------------------
manage_system_perf() {
    local action=$1; local vendor=$2
    if [[ "$action" == "on" ]]; then
        notify "INIT: Engaging Full Optimization..."
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo "performance" | sudo tee "$cpu" >/dev/null 2>&1; done
        for epp in /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference; do [[ -f "$epp" ]] && echo "performance" | sudo tee "$epp" >/dev/null; done
        echo "$SWAPPINESS_TARGET" | sudo tee /proc/sys/vm/swappiness > /dev/null

        pgrep -af "irq/.*nvidia" | awk '{print $1}' | xargs -r -I {} sudo chrt -f -p $RT_PRIO_NVIDIA {}
        pgrep -af "irq/.*xhci" | awk '{print $1}' | xargs -r -I {} sudo chrt -f -p $RT_PRIO_USB {}
        pgrep -x "pipewire" | xargs -r -I {} sudo chrt -f -p $RT_PRIO_PIPEWIRE {}

        case "$vendor" in
            nvidia | nvidia_hybrid | nvidia_nvk)
                sudo nvidia-smi -pm 1 >/dev/null 2>&1
                nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=1" > /dev/null 2>&1 ;;
            amd)
                echo "high" | sudo tee /sys/class/drm/card*/device/power_dpm_force_performance_level > /dev/null 2>&1 ;;
            intel)
                echo "1" | sudo tee /sys/kernel/debug/dri/0/i915_max_freq > /dev/null 2>&1 ;;
        esac
    else
        notify "EXIT: Restoring Defaults..."
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo "schedutil" | sudo tee "$cpu" >/dev/null 2>&1 || echo "powersave" | sudo tee "$cpu" >/dev/null 2>&1; done
        for epp in /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference; do [[ -f "$epp" ]] && echo "balance_performance" | sudo tee "$epp" >/dev/null; done
        echo 60 | sudo tee /proc/sys/vm/swappiness > /dev/null

        pgrep -af "irq/.*nvidia" | awk '{print $1}' | xargs -r -I {} sudo chrt -f -p $RESTORE_RT_PRIO_IRQ {}
        pgrep -af "irq/.*xhci" | awk '{print $1}' | xargs -r -I {} sudo chrt -f -p $RESTORE_RT_PRIO_IRQ {}
        pgrep -x "pipewire" | xargs -r -I {} sudo chrt -o -p 0 {}
        [[ "$vendor" == "nvidia" ]] && nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=0" > /dev/null 2>&1
    fi
}

manage_wifi_latency() {
    local interfaces=$(iw dev | awk '$1=="Interface"{print $2}')
    local p_state=$([[ "$1" == "on" ]] && echo "off" || echo "on")
    for dev in $interfaces; do sudo iw dev "$dev" set power_save "$p_state" 2>/dev/null; done
}

manage_bt_latency() {
    local hci_path="/sys/kernel/debug/bluetooth/hci0"
    [[ ! -d "$hci_path" ]] && return
    if [[ "$1" == "on" ]]; then
        echo 12 | sudo tee "$hci_path/conn_max_interval" > /dev/null 2>&1
        echo 6 | sudo tee "$hci_path/conn_min_interval" > /dev/null 2>&1
        pgrep -x "bluetoothd" | xargs -r -I {} sudo chrt -f -p $RT_PRIO_BT {}
    else
        echo 40 | sudo tee "$hci_path/conn_max_interval" > /dev/null 2>&1
        pgrep -x "bluetoothd" | xargs -r -I {} sudo chrt -o -p 0 {}
    fi
}

manage_scheduler() {
    if [[ "$1" == "on" ]]; then
        sudo scxctl stop >/dev/null 2>&1
        sleep 0.5
        notify "SCHED: Starting LAVD..."
        sudo scxctl start --sched lavd --mode gaming &
        sleep 2.0
    else
        notify "SCHED: Stopping custom scheduler..."
        sudo scxctl stop >/dev/null 2>&1
    fi
}

# ------------------------------------------------
# 5. MAIN
# ------------------------------------------------
[[ $EUID -ne 0 ]] && { notify "ERROR: Run with sudo!"; exit 1; }

while getopts "o:v:sh" opt; do
    case "$opt" in
        o) ACTION=$OPTARG ;;
        v) VENDOR=$OPTARG ;;
        s) check_status ; exit 0 ;;
        h|*) show_help ;;
    esac
done

if [[ "$ACTION" == "on" ]]; then
    manage_system_perf "on" "$VENDOR"
    manage_wifi_latency "on"
    manage_bt_latency "on"
    manage_scheduler "on"
    notify "SYSTEM: Performance mode ACTIVE."
elif [[ "$ACTION" == "off" ]]; then
    manage_system_perf "off" "$VENDOR"
    manage_wifi_latency "off"
    manage_bt_latency "off"
    manage_scheduler "off"
    notify "EXIT: Restoration Complete."
else
    show_help
fi
