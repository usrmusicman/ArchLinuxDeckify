#!/usr/bin/env bash

# ------------------------------------------------
# Find Configuration File
# ------------------------------------------------

if [ -z "$SYSTEM_GPU" ]; then

  # Source configuration file
  source "$STEAMOS_SESSION_CONFIG"

fi

# ------------------------------------------------
# Nvidia NVK+Nouveau High-Performance Gaming Environment
# ------------------------------------------------

# Essential: Clean the slate so the proprietary driver paths don't conflict
unset __GLX_VENDOR_LIBRARY_NAME
unset PROTON_ENABLE_NVAPI
unset PROTON_HIDE_NVIDIA_GPU

# Force the Nouveau/Mesa path
export MESA_LOADER_DRIVER_OVERRIDE=nouveau

# [NVK_DEBUG]: 'sync' ensures better frame pacing in Gamescope
# [NOUVEAU_MESA_DEBUG]: 'true' enables internal Mesa optimizations
export NVK_DEBUG=sync
export NOUVEAU_MESA_DEBUG=1

# [2026 NVK EXTRAS]: Enable multi-threaded shader compilation
# This is crucial to avoid massive stutters on FOSS NVIDIA drivers
export NVK_PERFTEST=gpl
export mesa_glthread=true

# Standard 64-bit NVK Vulkan ICD path
export VK_ICD_FILENAMES="/usr/share/vulkan/icd.d/nouveau_icd.x86_64.json"

# --- [EXPERIMENTAL] NVIDIA NOVA FOSS Environment ---

# Directing the system to the new Rust-based kernel module
#export MESA_LOADER_DRIVER_OVERRIDE=nova

# Enable the early Ray Tracing paths in the NVK driver
#export NVK_DEBUG=rt

# ------------------------------------------------
# Steamdeck Gamescope UI Session
# ------------------------------------------------

# Silencing systemctl and pkill (Added -q and &>/dev/null)
pkill -9 kwin_wayland 2>/dev/null
sleep 2

# 2. Run Gamescope with Upscaling Logic
# -w/-h = Internal Render (What the game thinks it is)
# -W/-H = Physical Output (The Monitor's resolution)
gamescope \
  -w "$RENDER_WIDTH" \
  -h "$RENDER_HEIGHT" \
  -W "$SCREENWIDTH" \
  -H "$SCREENHEIGHT" \
  -r "$REFRESHRATE" \
  -f \
  --adaptive-sync \
  --immediate-flips \
  --force-grab-cursor \
  -S fit \
  -F "$UPSCALE_FILTER" \
  --sharpness "$SHARPNESS" \
  --hdr-enabled \
  --mangoapp \
  --steam \
  --xwayland-count 2 \
  -- \
  steam -steamdeck -steamos3 -gamepadui >/dev/null 2>$HOME/.steamos-session-gamescope.log
