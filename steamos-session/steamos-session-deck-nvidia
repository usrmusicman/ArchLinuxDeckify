#!/usr/bin/env bash

# ------------------------------------------------
# Find Configuration File
# ------------------------------------------------

if [ -z "$SYSTEM_GPU" ]; then

  # Source configuration file
  source "$STEAMOS_SESSION_CONFIG"

fi

# ------------------------------------------------
# NVIDIA High-Performance Gaming Environment
# ------------------------------------------------

# --- LATENCY & SYNC ---
# Limits pre-rendered frames. At 360Hz, this is the #1 variable for "instant" mouse feel.
export __GL_MaxFramesAllowed=1

# Essential for G-Sync/VRR to function within a Wayland/Gamescope container.
export __GL_GSYNC_ALLOWED=1
export __GL_VRR_ALLOWED=1

# --- DRIVER EXECUTION (THE CAUTIONS) ---
# [CAUTION]: USLEEP is safer for 360Hz. "NOTHING" can starve the CPU and cause freezes.
export __GL_YIELD="USLEEP"

# Speeds up CPU-to-GPU data transfers. Safe and helpful for high-refresh pacing.
export __GL_WRITE_COMBINED_MEMORY=1

# --- SHADER CACHE ---
# Forces the driver to store shaders on disk instead of re-compiling every launch.
export __GL_SHADER_DISK_CACHE=1
export __GL_SHADER_DISK_CACHE_PATH="$HOME/.cache/nvidia"

# --- COMPOSITOR HANDOFF ---
# Mandatory: Tells applications to use the proprietary NVIDIA driver path.
export __GLX_VENDOR_LIBRARY_NAME=nvidia
export GBM_BACKEND=nvidia-drm

# [CAUTION]: Removed WLR_DRM_NO_ATOMIC.
# Modern 2026 drivers REQUIRE Atomic Modesetting for stable 360Hz/HDR output.
# If you see flickering, re-enable only as a last resort.

# Fixes invisible or glitchy cursors in Gamescope.
export WLR_NO_HARDWARE_CURSORS=1

# --- PROTON & FEATURES ---
# Enables the bridge between Windows games and your NVIDIA driver features.
export PROTON_ENABLE_NVAPI=1
export PROTON_HIDE_NVIDIA_GPU=0

# [NEW 2026]: Restricts libs to 64-bit to prevent performance regressions on RTX 40-series.
export PROTON_NVIDIA_LIBS_NO_32BIT=1

# Points specifically to your NVIDIA Vulkan implementation.
export VK_ICD_FILENAMES="/usr/share/vulkan/icd.d/nvidia_icd.json"

# ------------------------------------------------
# Steamdeck Gamescope UI Session
# ------------------------------------------------

# 1. Silencing GPU setup & power logs (Added &>/dev/null)
sudo /usr/bin/nvidia-smi -pm 1 2>/dev/null
sudo /usr/bin/nvidia-smi -pl $NVIDIA_PW_LIMIT 2>/dev/null # Optional: Lock power limit

# 2. Log power health silently to file
{
  echo "--- GPU Power Health Check ---"
  nvidia-smi --query-gpu=timestamp,power.draw,power.limit,temperature.gpu --format=csv
} > $HOME/.steamos-session-gpu-check.log

# 3. Silencing systemctl and pkill (Added -q and &>/dev/null)
sudo /usr/bin/systemctl mask getty@tty${DESKTOP_TTY}.service 2>/dev/null
pkill -9 kwin_wayland 2>/dev/null
clear

# 4. Run Gamescope with Upscaling Logic
# -w/-h = Internal Render (What the game thinks it is)
# -W/-H = Physical Output (The Monitor's resolution)
gamescope \
  -w "$RENDER_WIDTH" \
  -h "$RENDER_HEIGHT" \
  -W "$SCREENWIDTH" \
  -H "$SCREENHEIGHT" \
  -r "$REFRESHRATE" \
  -f \
  --adaptive-sync \
  --immediate-flips \
  --force-grab-cursor \
  -S fit \
  -F "$UPSCALE_FILTER" \
  --sharpness "$SHARPNESS" \
  --hdr-enabled \
  --mangoapp \
  --steam \
  --xwayland-count 2 \
  -- \
  steam -steamdeck -steamos3 -gamepadui >/dev/null 2>$HOME/.steamos-session-gamescope.log

# 5. Cleanup (Silenced)
sudo /usr/bin/systemctl unmask getty@tty${DESKTOP_TTY}.service 2>/dev/null
sudo /usr/bin/systemctl restart getty@tty${DESKTOP_TTY}.service 2>/dev/null
sudo /usr/bin/chvt $DESKTOP_TTY &>/dev/null

sudo /usr/bin/systemctl mask getty@tty${STEAMDECKUI_TTY}.service 2>/dev/null
clear
sudo /usr/bin/systemctl stop getty@tty${STEAMDECKUI_TTY}.service 2>/dev/null
